{% extends 'base.html' %}

{% block extra_head %}
<style>
    #map {
        height: 500px;
        width: 100%;
        margin-top: 20px;
    }
    #error-message {
        display: none;
        margin-top: 10px;
        padding: 10px;
        border-radius: 4px;
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
</style>
{% endblock %}

{% block title %}
    Find Nearest Spot
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="text-center mb-4">Find Nearest Parking Spot</h1>
    <div id="error-message"></div>
    <div id="map"></div>
</div>

<script>
    // Initialize the map centered on a default location
    const map = L.map('map').setView([44.4268, 26.1025], 13); // Default to Bucharest

    // Add the OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
    }).addTo(map);

    // Create an icon for parking spots
    const parkingIcon = L.icon({
        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
    });

    // Add parking spot markers from the database
    const parkingSpots = JSON.parse('{{ locations|escapejs }}');
    if (parkingSpots && parkingSpots.length) {
        parkingSpots.forEach(spot => {
            L.marker([spot.latitude, spot.longitude], {icon: parkingIcon})
             .addTo(map)
             .bindPopup('Parking Spot');
        });
    }

    // Get user's location
    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;
            
            // Center map on user's location
            map.setView([userLat, userLng], 15);

            // Add marker for user's location with a different color
            const userIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
            });

            const userMarker = L.marker([userLat, userLng], {icon: userIcon})
                .addTo(map)
                .bindPopup('You are here')
                .openPopup();

        }, function(error) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.style.display = 'block';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorDiv.textContent = "Please enable location services to find parking spots near you.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorDiv.textContent = "Location information is unavailable.";
                    break;
                case error.TIMEOUT:
                    errorDiv.textContent = "Location request timed out.";
                    break;
                default:
                    errorDiv.textContent = "An unknown error occurred while getting your location.";
            }
        });
    } else {
        const errorDiv = document.getElementById('error-message');
        errorDiv.style.display = 'block';
        errorDiv.textContent = "Geolocation is not supported by your browser";
    }
</script>
{% endblock %}
