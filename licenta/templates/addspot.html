{% extends 'base.html' %}

{% block title %}
    Add Spot
{% endblock %}

{% block content %}
<div class="container">
    <div class="form-container">
        <h2 class="mb-4">Add New Parking Spot</h2>
        
        <form method="POST" enctype="multipart/form-data" id="addSpotForm">
            {% csrf_token %}
            <div class="mb-3">
                <label for="name" class="form-label">Spot Name</label>
                <input type="text" class="form-control" 
                       id="name" name="name" required value="{{ form.name.value|default:'' }}">
            </div>

            <div class="mb-3">
                <label class="form-label">Location</label>
                <div id="map"></div>
                <input type="hidden" id="latitude" name="latitude" required value="{{ form.latitude.value|default:'' }}">
                <input type="hidden" id="longitude" name="longitude" required value="{{ form.longitude.value|default:'' }}">
                <small class="text-muted">Click on the map to set the location or use your current location</small>
            </div>
            <button type="button" class="btn btn-primary mb-3" onclick="useCurrentLocation()">Use My Location</button>

            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea class="form-control" 
                          id="description" name="description" rows="3">{{ form.description.value|default:'' }}</textarea>
            </div>

            <div class="mb-3">
                <label for="image" class="form-label">Image</label>
                <input type="file" class="form-control" 
                       id="image" name="image" accept="image/*" onchange="previewImage(this);">
                <img id="preview" class="preview-image d-none">
            </div>

            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="available" 
                           name="available" {% if form.available.value %}checked{% endif %}>
                    <label class="form-check-label" for="available">
                        Spot is currently available
                    </label>
                </div>
            </div>

            <button type="submit" class="btn btn-primary mb-5">Add Spot</button>
        </form>
    </div>
</div>

<script>
    const map = L.map('map').setView([44.4268, 26.1025], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
    }).addTo(map);

    let marker = null;

    // Handle map clicks to set location
    map.on('click', function(e) {
        setLocation(e.latlng.lat, e.latlng.lng);
    });

    function setLocation(lat, lng) {
        if (marker) {
            marker.setLatLng([lat, lng]);
        } else {
            marker = L.marker([lat, lng]).addTo(map);
        }
        document.getElementById('latitude').value = lat;
        document.getElementById('longitude').value = lng;
        map.setView([lat, lng], 15);
    }

    // Use current location
    function useCurrentLocation() {
        if ("geolocation" in navigator) {
            navigator.geolocation.getCurrentPosition(function(position) {
                setLocation(position.coords.latitude, position.coords.longitude);
            }, function(error) {
                alert("Error getting location: " + error.message);
            });
        } else {
            alert("Geolocation is not supported by your browser");
        }
    }

    // Image preview
    function previewImage(input) {
        const preview = document.getElementById('preview');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.classList.remove('d-none');
            }
            reader.readAsDataURL(input.files[0]);
        }
    }

    // Form validation
    document.getElementById('addSpotForm').onsubmit = function(e) {
        if (!document.getElementById('latitude').value || !document.getElementById('longitude').value) {
            e.preventDefault();
            alert('Please select a location on the map');
            return false;
        }
        return true;
    };
</script>
{% endblock %}